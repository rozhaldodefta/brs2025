<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRS - BPS Kabupaten Berau</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
body { background-color: #f8f9fa; }
.table-responsive { box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 0.25rem; }
.page-link { color: #0056b3; }
.page-item.active .page-link { background-color: #0056b3; border-color: #0056b3; }
</style>
</head>

<body>
<main class="container py-4">
    <h1 class="mb-4 text-center">Berita Resmi Statistik</h1>

    <!-- (SEARCH DIHAPUS) -->

    <div id="content"></div>
</main>

<script>
// ========================================================
// GET URL PARAM
// ========================================================
function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// ========================================================
// MODE DETAIL / LIST
// ========================================================
const brsID = getParam("id");

if (brsID) {
    loadDetail(brsID);
} else {
    loadList();
}

// ========================================================
// DETAIL PAGE
// ========================================================
function loadDetail(id) {
    const url = `https://webapi.bps.go.id/v1/api/view/domain/6405/model/pressrelease/lang/ind/key/0e72953589cf3d4f628338969e2b5819/id/${id}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (!data.data) {
                document.getElementById("content").innerHTML =
                    `<div class="alert alert-warning text-center">Data tidak ditemukan.</div>`;
                return;
            }

            const brs = data.data;

            document.getElementById("content").innerHTML = `
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h1 class="card-title mb-3">${brs.title}</h1>
                        <p class="text-muted mb-3">Tanggal Rilis: ${brs.rl_date ?? "-"}</p>

                        <div class="card mb-3 p-3 bg-light">
                            ${brs.abstract}
                        </div>

                        <a href="${brs.pdf}" target="_blank" class="btn btn-success">
                            Download PDF (${brs.size})
                        </a>

                        <a href="index.html" class="btn btn-secondary ms-2">Kembali</a>
                    </div>
                </div>
            `;
        })
        .catch(err => {
            document.getElementById("content").innerHTML =
                `<div class="alert alert-danger text-center">Gagal mengambil data.</div>`;
        });
}

// ========================================================
// LIST PAGE
// ========================================================
function loadList() {
    const page = getParam("page") ? parseInt(getParam("page")) : 1;

    const key = "0e72953589cf3d4f628338969e2b5819";
    let url =
        `https://webapi.bps.go.id/v1/api/list/model/pressrelease/lang/ind/year/2025/domain/6405/key/${key}?page=${page}`;

    fetch(url)
        .then(res => res.json())
        .then(json => {
            if (!json.data) {
                document.getElementById("content").innerHTML =
                    `<div class="alert alert-danger text-center">Tidak dapat memuat data API.</div>`;
                return;
            }

            // Format API baru/lama
            let meta, list;

            if (Array.isArray(json.data)) {
                meta = json.data[0];
                list = json.data[1];
            } else {
                meta = json.data;
                list = json.data.result;
            }

            const totalPages = meta.pages;
            const totalData  = meta.total ?? meta.datacount;
            const perPage    = meta.perpage;

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="mb-0 text-muted">Menampilkan
                        <strong>${list.length}</strong> dari total
                        <strong>${totalData}</strong> publikasi.
                    </p>

                    <p class="mb-0 text-muted">Halaman
                        <strong>${page}</strong> dari <strong>${totalPages}</strong>
                    </p>
                </div>
            `;

            // ====================
            // TABEL
            // ====================
            html += `
            <div class="table-responsive mb-4">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-primary">
                <tr>
                    <th style="width:5%;">No</th>
                    <th>Judul Berita</th>
                    <th style="width:20%;">Tanggal Rilis</th>
                </tr>
                </thead>
                <tbody>
            `;

            const start = ((page - 1) * perPage) + 1;

            list.forEach((brs, index) => {
                const nomor = start + index;

                const tgl = new Date(brs.rl_date).toLocaleDateString("id-ID", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric"
                });

                html += `
                    <tr>
                        <th>${nomor}</th>
                        <td>
                            <a href="index.html?id=${brs.brs_id}" class="fw-semibold text-decoration-none">
                                ${brs.title}
                            </a>
                        </td>
                        <td>${tgl}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;

            // ====================
            // PAGINATION
            // ====================
            html += buildPagination(page, totalPages);

            document.getElementById("content").innerHTML = html;

        })
        .catch(err => {
            document.getElementById("content").innerHTML =
                `<div class="alert alert-danger text-center">Gagal memuat data.</div>`;
        });
}

// ========================================================
// PAGINATION
// ========================================================
function buildPagination(page, total) {
    if (total <= 1) return "";

    function link(p) {
        return `?page=${p}`;
    }

    let html = `<nav><ul class="pagination justify-content-center flex-wrap">`;

    html += `
        <li class="page-item ${page === 1 ? "disabled" : ""}">
            <a class="page-link" href="${link(1)}">
                <i class="bi bi-chevron-double-left"></i> First
            </a>
        </li>

        <li class="page-item ${page === 1 ? "disabled" : ""}">
            <a class="page-link" href="${link(page - 1)}">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        </li>
    `;

    const range = 2;
    const start = Math.max(1, page - range);
    const end = Math.min(total, page + range);

    if (start > 1) {
        html += `<li class="page-item"><a class="page-link" href="${link(1)}">1</a></li>`;
        if (start > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }

    for (let i = start; i <= end; i++) {
        html += `
            <li class="page-item ${i === page ? "active" : ""}">
                <a class="page-link" href="${link(i)}">${i}</a>
            </li>`;
    }

    if (end < total) {
        if (end < total - 1)
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        html += `<li class="page-item"><a class="page-link" href="${link(total)}">${total}</a></li>`;
    }

    html += `
        <li class="page-item ${page === total ? "disabled" : ""}">
            <a class="page-link" href="${link(page + 1)}">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </li>

        <li class="page-item ${page === total ? "disabled" : ""}">
            <a class="page-link" href="${link(total)}">
                Last <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
    `;

    html += `</ul></nav>`;
    return html;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<script>
// =============================
// PROXY AGAR API BPS BISA DIAMBIL
// =============================
const PROXY_URL = "https://brs.rozhaldodefta.workers.dev";

// Fungsi fetch lewat proxy
function fetchAPI(url) {
    return fetch(PROXY_URL + "?url=" + encodeURIComponent(url))
           .then(res => res.json());
}

// ========================================================
// GET URL PARAM
// ========================================================
function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// ========================================================
// MODE DETAIL / LIST
// ========================================================
const brsID = getParam("id");

if (brsID) {
    loadDetail(brsID);
} else {
    loadList();
}

// ========================================================
// DETAIL PAGE
// ========================================================
function loadDetail(id) {

    const url =
      `https://webapi.bps.go.id/v1/api/view/domain/6405/model/pressrelease/lang/ind/key/0e72953589cf3d4f628338969e2b5819/id/${id}`;

    fetchAPI(url)
        .then(data => {
            if (!data.data) {
                document.getElementById("content").innerHTML =
                    `<div class="alert alert-warning text-center">Data tidak ditemukan.</div>`;
                return;
            }

            const brs = data.data;

            document.getElementById("content").innerHTML = `
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h1 class="card-title mb-3">${brs.title}</h1>
                        <p class="text-muted mb-3">Tanggal Rilis: ${brs.rl_date ?? "-"}</p>

                        <div class="card mb-3 p-3 bg-light">
                            ${brs.abstract}
                        </div>

                        <a href="${brs.pdf}" target="_blank" class="btn btn-success">
                            Download PDF (${brs.size})
                        </a>

                        <a href="index.html" class="btn btn-secondary ms-2">Kembali</a>
                    </div>
                </div>
            `;
        })
        .catch(err => {
            document.getElementById("content").innerHTML =
                `<div class="alert alert-danger text-center">Gagal mengambil data.</div>`;
        });
}

// ========================================================
// LIST PAGE
// ========================================================
function loadList() {
    const page = getParam("page") ? parseInt(getParam("page")) : 1;

    const key = "0e72953589cf3d4f628338969e2b5819";

    const url =
      `https://webapi.bps.go.id/v1/api/list/model/pressrelease/lang/ind/year/2025/domain/6405/key/${key}?page=${page}`;

    fetchAPI(url)
        .then(json => {
            if (!json.data) {
                document.getElementById("content").innerHTML =
                    `<div class="alert alert-danger text-center">Tidak dapat memuat data API.</div>`;
                return;
            }

            // Format API baru/lama
            let meta, list;

            if (Array.isArray(json.data)) {
                meta = json.data[0];
                list = json.data[1];
            } else {
                meta = json.data;
                list = json.data.result;
            }

            const totalPages = meta.pages;
            const totalData  = meta.total ?? meta.datacount;
            const perPage    = meta.perpage;

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="mb-0 text-muted">Menampilkan
                        <strong>${list.length}</strong> dari total
                        <strong>${totalData}</strong> publikasi.
                    </p>

                    <p class="mb-0 text-muted">Halaman
                        <strong>${page}</strong> dari <strong>${totalPages}</strong>
                    </p>
                </div>
            `;

            // ====================
            // TABEL
            // ====================
            html += `
            <div class="table-responsive mb-4">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-primary">
                <tr>
                    <th style="width:5%;">No</th>
                    <th>Judul Berita</th>
                    <th style="width:20%;">Tanggal Rilis</th>
                </tr>
                </thead>
                <tbody>
            `;

            const start = ((page - 1) * perPage) + 1;

            list.forEach((brs, index) => {
                const nomor = start + index;

                const tgl = new Date(brs.rl_date).toLocaleDateString("id-ID", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric"
                });

                html += `
                    <tr>
                        <th>${nomor}</th>
                        <td>
                            <a href="index.html?id=${brs.brs_id}" class="fw-semibold text-decoration-none">
                                ${brs.title}
                            </a>
                        </td>
                        <td>${tgl}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;

            // PAGINATION
            html += buildPagination(page, totalPages);

            document.getElementById("content").innerHTML = html;

        })
        .catch(err => {
            document.getElementById("content").innerHTML =
                `<div class="alert alert-danger text-center">Gagal memuat data.</div>`;
        });
}

// ========================================================
// PAGINATION (TIDAK DIUBAH)
// ========================================================
function buildPagination(page, total) {
    if (total <= 1) return "";

    function link(p) {
        return `?page=${p}`;
    }

    let html = `<nav><ul class="pagination justify-content-center flex-wrap">`;

    html += `
        <li class="page-item ${page === 1 ? "disabled" : ""}">
            <a class="page-link" href="${link(1)}">
                <i class="bi bi-chevron-double-left"></i> First
            </a>
        </li>

        <li class="page-item ${page === 1 ? "disabled" : ""}">
            <a class="page-link" href="${link(page - 1)}">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        </li>
    `;

    const range = 2;
    const start = Math.max(1, page - range);
    const end = Math.min(total, page + range);

    if (start > 1) {
        html += `<li class="page-item"><a class="page-link" href="${link(1)}">1</a></li>`;
        if (start > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }

    for (let i = start; i <= end; i++) {
        html += `
            <li class="page-item ${i === page ? "active" : ""}">
                <a class="page-link" href="${link(i)}">${i}</a>
            </li>`;
    }

    if (end < total) {
        if (end < total - 1)
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        html += `<li class="page-item"><a class="page-link" href="${link(total)}">${total}</a></li>`;
    }

    html += `
        <li class="page-item ${page === total ? "disabled" : ""}">
            <a class="page-link" href="${link(page + 1)}">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </li>

        <li class="page-item ${page === total ? "disabled" : ""}">
            <a class="page-link" href="${link(total)}">
                Last <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
    `;

    html += `</ul></nav>`;
    return html;
}
</script>

